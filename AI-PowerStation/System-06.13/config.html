<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/system.css" rel="stylesheet">
</head>
<body>
<div class="loading loadingin">
    <img src="image/loading.gif" alt=""/>
</div>
<!--导航栏-->
<div class="nav">
    <div class="container">
        <div class="row">
            <div class="col-xs-4">
                <div class="log-box">
                    <img src="image/log.png" alt=""/>
                    <span>南京控客信息技术有限公司</span>
                </div>
            </div>
            <!--<div class="col-xs-8 nav-rg">-->
            <!--<div class="exponent-box">-->
            <!--<span><i></i><b>25°</b></span>-->
            <!--<span><i></i><b>25°</b></span>-->
            <!--<span><i></i><b>25°</b></span>-->
            <!--</div>-->
            <!--<div class="date-box">-->
            <!--<span>2017年4月11日</span>-->
            <!--<span>星期四</span>-->
            <!--<span>8:30</span>-->
            <!--</div>-->
            <!--</div>-->
        </div>
    </div>
</div>
<div class="guanli main">
    <div class="main-lf-btn">
        <button class="system-btn"data-toggle='modal'data-target="#maintenance" id="add0">添加</button>
        <button class="system-btn" id="return">返回</button>
        <div class=""></div>
    </div>
    <div class="main-rg-tb">
        <div  id="example2">
            <div class="table-box1">
                <table class="table2 table-bordered table-h">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>房间</th>
                        <th>情景名称</th>
                        <th>情景选择</th>
                        <th width="30%">操作</th>
                    </tr>
                    </thead>
                </table>
                <b class="scroll-add" style=""></b>
            </div>
            <div class="table-box2">
                <table class="table2 table-bordered table-b">
                    <tbody>
                    </tbody>
                </table>
            </div>
        <div class="btn-box">
            <button class="system-btn right fade" id="add-action">编辑</button>
            <button class="system-btn right" id="add-line" style="display:none">添加一行</button>
            <button class="system-btn right" id="save-action" style="display:none">保存</button>
        </div>
        <table class="table2 table-bordered"id="example4">
            <thead>
            <tr>
                <th>房间ID</th>
                <th>设备类型</th>
                <th>设备名称</th>
                <th>状态(开/关)</th>
                <th>延时值</th>
            </tr>
            </thead>
            <tbody>
                <!--<tr>-->
                    <!--<td>1</td>-->
                    <!--<td>2</td>-->
                    <!--<td>3</td>-->
                    <!--<td>4</td>-->
                    <!--<td>5</td>-->
                <!--</tr>-->
            </tbody>
        </table>

    </div>
    <div class="modal fade" id="maintenance" tabindex="-1" role="dialog" aria-labelledby="ModalLabel1" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog" style="width:560px;margin-top: 220px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h4 class="modal-title" >
                        情景设置
                    </h4>
                </div>
                <div class="modal-body" id="flex">
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>
</div>
</body>
<script src="js/jQuery-2.1.4.min.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/sdk/SH_SDK_v1.1.2.js"></script>
<script type="text/javascript" src="js/gateway.js"></script>
<script type="text/javascript" src="js/displayInformation.js"></script>
<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript" src="js/operate.js"></script>
<script type="text/javascript" src="js/scene.js"></script>
<script type="text/javascript" src="js/IFTTT.js"></script>
<script type="text/javascript" src="js/dianzhan.js"></script>
<script>

var tempHost = null;
var str=null;
var tempnn=0;
var roomI='';
function connect() {
    var deviceId = localStorage['code'];
    var accessKey = localStorage['ktt'];


    // 生成主机对象
    tempHost = new SHost(deviceId, accessKey);

    // 初始化主机
    tempHost.init();

    // 注册主机状态推送
    tempHost.registerHostStatusCallbackFunc(callBack);

    // 注册主机设备状态推送
    tempHost.registerDevicesStatusCallbackFunc(deviceCallBack);
}
if(localStorage['code']!=null) {
    connect();
}

function callBack(temp) {
    console.warn(temp);
    var tempJson = JSON.parse(temp);
    if (tempJson.status.statusStep == "link" && tempJson.status.statusValue == 1) {
        $("#link").html('链接成功');
    }
    if (tempJson.status.statusStep == "login" && tempJson.status.statusValue == 1) {
        $("#login").html('登录成功');
    }
    if (tempJson.status.statusStep == "synch" && tempJson.status.statusValue == 1) {
        $("#synch").html('信息同步成功');
        str=showScenes();
        roomI=tempHost.hostDataRepository.getAllRoomsInfo()[0].id;
        if(str!=''&&str!=undefined){
            var html='';
            for(var i=0;i<str.length;i++){
                console.error(str[i]);
                html+=`
                <tr>
                    <td>${str[i].id}</td>
                    <td>${str[i].roomId}</td>
                    <td>${str[i].name}</td>
                    <td>${str[i].sceneType}</td>
                    <td>
                    <a href="#" onclick="showT(${i})">查看</a>
                    <span>|</span>
                    <a href="#" onclick="revT(${i})"data-toggle="modal" data-target="#maintenance" >修改</a>
                    <span>|</span>
                    <a href="#"onclick=deleteT("${str[i].id}")>删除</a>
                    </td>
                </tr>
                `;
            }
            $('#example2 .table-box2 tbody').empty().html(html);

        }
    }
    var address=$('#example2');
    table_djust(address,6);
}
function showT(n){
    $('#add-action').removeClass('fade');
    str=showScenes();
    tempnn=n;
    console.error(str[n])
    var html2=''
    for(var i=0;i<str[n].actions.length;i++){
        var deviceT='';
        switch (str[n].actions[i].deviceType) {
            case 'ZIGBEE_Light':
                deviceT='灯';
                break;
            case 'ZIGBEE_KonkeSocket':
                deviceT='智能插座';
                break;
            case 'ZIGBEE_InfraredSensor':
                deviceT='人体红外';
                break;
            case 'ZIGBEE_SmokeSensor':
                deviceT='烟感';
                break;
            case 'ZIGBEE_DipSensor':
                deviceT='水浸传感';
                break;
            case 'ZIGBEE_DoorSensor':
                deviceT='门磁';
                break;
            case 'ZIGBEE_TempSensor':
                deviceT='温度传感器';
                break;
            case 'ZIGBEE_HumiSensor':
                deviceT='湿度传感器';
                break;
        }
        html2+=`
        <tr>
            <td>${str[n].actions[i].roomId}</td>
            <td>${deviceT}</td>
            <td>${str[n].actions[i].name}</td>
            <td>${str[n].actions[i].operation}</td>
            <td>${str[n].actions[i].delay}</td>
            </tr>
            `
    }
    $('#example4 tbody').empty().html(html2);
}
function deviceCallBack(temp) {
    str=showScenes();
}


function checkHostObject() {
    if (tempHost== null) {
        return false;
    }
    return true;
}
//查看相应主机下的设备
$('#add0').click(function(){
    $('#flex').html(
            `
    <div class="pop-main">
    <div class="monitor-station">
    <div class="head-box">
    <form id="hostADD">

    <div class="row">
    <div class="col-xs-12">
    <span>情景名称</span>
    <input type="text"id="sceneName" data-type='1'>
    </div>
    <div class="col-xs-12">
    <span>应用房间</span>
    <input type="text"id="sceneRoomId" data-type='2'value='${roomI}'disabled>
    </div>
    <div class="col-xs-12">
    <span>情景选择</span>
    <input type="text"id="sceneType" data-type='3'>
    </div>
    </div>
    <div class="row"><div class="col-xs-4"></div><div class="col-xs-4"></div><div class="col-xs-4"><botton type="button" class="btn system-btn" id="insH">保存</botton></div></div>
    </form>
    </div>
    </div>
    </div>
                `
    )
})

var tempD="";
function revTime(n){
    $('#flex').html(
            `
    <div class="pop-main">
        <div class="monitor-station">
        <p class="main-title">修改时间</p>

        <div class="head-box">
        <form id="hostADD">

        <div class="row">
        <input type="hidden"id="sceneId"value=${n}>
    <div class="col-xs-12"><span>启用天</span><input type="text"id="sceneWeek"></div>
        <div class="col-xs-12"><span>启用时</span><input type="text"id="sceneTime"></div>
        <div class="col-xs-12"><span>是否启用</span><select id="sceneEnable" style="width:200px">
        <option value="true">启用</option>
        <option value="false">禁用</option>
        </select></div>
        </div>
        <div class="row"><div class="col-xs-4"></div><div class="col-xs-4"></div><div class="col-xs-4"><botton type="button" class="btn system-btn"id="timeS">保存</botton></div></div>
        </form>
        </div>
        </div>
        </div>

                `
    )
}
$('#add-line').click(function(){
    var tr;
    var nn=$('#example4 tr').length-1;
    tr=`
        <tr>
        <td id="roomId${nn}">${str[tempnn].roomId}</td>
        <td><select id="deviceType${nn}">
        <option value="0">请选择</option>
        <option value="ZIGBEE_Light">灯</option>
        <option value="ZIGBEE_InfraredTransponder">红外遥控</option>
        <option value="ZIGBEE_CurtainMotor">窗帘电机</option>
        <option value="ZIGBEE_KonkeSocket">智能插座</option>
        <option value="ZIGBEE_InfraredSensor">人体红外</option>
        <option value="ZIGBEE_SmokeSensor">烟感</option>
        <option value="ZIGBEE_DipSensor">水浸</option>
        <option value="ZIGBEE_DoorSensor">门禁</option>
        <option value="ZIGBEE_TempSensor">温度传感</option>
        <option value="ZIGBEE_HumiSensor">湿度传感</option>
        </select>
        </td>
        <td><select id="deviceName${nn}">
        <option value=""></option>
        </select>
        </td>
        <td>
        <select id="OOC${nn}" style="width:200px">
        <option value="OFF">OFF</option>
        <option value="ON">ON</option>
        </select>
        </td>
        <td><input type='text'  id="delay${nn}"value=""></td>
        </tr>
        `
    $('#example4 tbody').append(tr);
    for(var i=0;i<$('#example4 tr').length;i++) {
        (function(i) {
            var roomId = '#roomId' + i;
            var deviceType = '#deviceType' + i;
            var deviceName = '#deviceName' + i;
            var OOC = '#OOC' + i;
            var delay = '#delay' + i;
            $('#example4').on('change', deviceType, function () {
                console.error(deviceType)
                var html3 = '';
                for (var i = 0; i < tempD.length; i++) {
                    (function (i) {
                        if (tempD[i].deviceType == $(deviceType).val()) {
                            html3 += `
                            <option value="${tempD[i].id}">${tempD[i].name}</option>
                    `
                        }
                    })(i)
                }
                $(deviceName).html(html3);
                $(OOC).html(`
                    <option value="OFF">OFF</option>
                    <option value="ON">ON</option>
           `)
                $(delay).html(`
                    <input type='text' id=delay>
            `)
            })
        })(i)
    }
    $("#save-action").unbind("click");
    $('#save-action').click(function(){
        $(this).css('display','none');
        $('#add-line').css('display','none');
        $('#add-action').css('display','inline-block');
        var arrA=[];
        for(var i=0;i<$('#example4 tr').length-1;i++){
            (function(i) {
                var roomId = '#roomId' + i;
                var deviceType = '#deviceType' + i;
                var deviceName = '#deviceName' + i;
                var OOC = '#OOC' + i;
                var delay = '#delay' + i;
                arrA.push({
                    "id": $(deviceName).val(),
                    "area": "11",
                    "name": $(deviceName).find("option:selected").text(),
                    "roomId": $(roomId).text(),
                    "operation": $(OOC).val(),
                    "deviceType": $(deviceType).val(),
                    "delay": $(delay).val()
                })
            })(i)
        }
        console.error(arrA);
        tempHost.asyncSetSceneAction(str[tempnn].id, arrA);
        setTimeout(function(){
            location.reload()
        },1000)
    })
})
$('#add-action').click(function(){
    $(this).css('display','none');
    $('#save-action').css('display','inline-block');
    $('#add-line').css('display','inline-block');
    tempD=showAllDevices();
    var html2='' ;
    console.error(tempD);
    for(var i=0;i<str[tempnn].actions.length;i++){
        html2+=`
        <tr>
            <td id="roomId${i}">${str[tempnn].actions[i].roomId}</td>
            <td><select id="deviceType${i}">
            <option value="${str[tempnn].actions[i].deviceType}">请选择</option>
            <option value="ZIGBEE_Light">灯</option>
            <option value="ZIGBEE_InfraredTransponder">红外遥控</option>
            <option value="ZIGBEE_CurtainMotor">窗帘电机</option>
            <option value="ZIGBEE_KonkeSocket">智能插座</option>
            <option value="ZIGBEE_InfraredSensor">人体红外</option>
            <option value="ZIGBEE_SmokeSensor">烟感</option>
            <option value="ZIGBEE_DipSensor">水浸</option>
            <option value="ZIGBEE_DoorSensor">门禁</option>
            <option value="ZIGBEE_TempSensor">温度传感</option>
            <option value="ZIGBEE_HumiSensor">湿度传感</option>
            </select>
            </td>
            <td><select id="deviceName${i}">
            <option value="${str[tempnn].actions[i].id}">${str[tempnn].actions[i].name}</option>
            </select>
            </td>
            <td>
            <select id="OOC${i}" style="width:200px">
            <option>${str[tempnn].actions[i].operation}</option>
            </select>
            </td>
            <td><input type='text'  id="delay${i}"value="${str[tempnn].actions[i].delay}"></td>
            </tr>
        `
    }
    $('#example4 tbody').empty().html(html2);
    for(var i=0;i<$('#example4 tr').length;i++) {
        (function(i) {
            var roomId = '#roomId' + i;
            var deviceType = '#deviceType' + i;
            var deviceName = '#deviceName' + i;
            var OOC = '#OOC' + i;
            var delay = '#delay' + i;
            $('#example4').on('change', deviceType, function () {
                console.error(deviceType)
                var html3 = '';
                for (var i = 0; i < tempD.length; i++) {
                    (function (i) {
                        if (tempD[i].deviceType == $(deviceType).val()) {
                            html3 += `
                            <option value="${tempD[i].id}">${tempD[i].name}</option>
                    `
                        }
                    })(i)
                }
                $(deviceName).html(html3);
                $(OOC).html(`
                    <option value="OFF">OFF</option>
                    <option value="ON">ON</option>
           `)
                $(delay).html(`
                    <input type='text' id=delay>
            `)
            })
        })(i)
    }


})
$('#save-action').click(function(){
    $(this).css('display','none');
    $('#add-line').css('display','none');
    $('#add-action').css('display','block');
    var arrA=[];
    for(var i=0;i<$('#example4 tr').length-1;i++){
        (function(i) {
            var roomId = '#roomId' + i;
            var deviceType = '#deviceType' + i;
            var deviceName = '#deviceName' + i;
            var OOC = '#OOC' + i;
            var delay = '#delay' + i;
            if($(deviceType).val()=="ZIGBEE_InfraredTransponder"){
                OOC="空调打开"
            }else{
                OOC=$(OOC).val()
            }
            arrA.push({
                "id": $(deviceName).val(),
                "area": "11",
                "name": $(deviceName).find("option:selected").text(),
                "roomId": $(roomId).text(),
                "operation": $(OOC).val(),
                "deviceType": $(deviceType).val(),
                "delay": $(delay).val()
            })
        })(i)
    }
    console.error(arrA);
    tempHost.asyncSetSceneAction(str[tempnn].id, arrA);
})
$('#maintenance').on('click','#insH',function(){
    addScene();
    $('body').find('.loading').addClass('loadingin');
    setTimeout(function(){
        location.reload()
    },2000)
})
$('#maintenance').on('click','#revS',function(){
    editScene()
    setTimeout(function(){location.reload()},5000)

    $( '#maintenance' ).modal( 'hide' );

})
function deleteT(n){
    if(confirm('确认删除该模式吗？')){
        tempHost.asyncDeleteScene(n);
        refresh.destroy();
        setTimeout(function(){connect()},1000)
    }
}
function revT(n){
    $('#flex').html(
            `
    <div class="pop-main">
        <div class="monitor-station">

        <div class="head-box">
        <form id="hostADD">

        <div class="row">
        <input type="hidden"id="sceneId"value="${str[n].id}">
        <div class="col-xs-12"><span>情景名称</span><input type="text"id="sceneName"></div>
        <div class="col-xs-12"><span>应用房间</span><input type="text"id="sceneRoomId" data-type='2'value='${roomI}'disabled></div>
        <div class="col-xs-12"><span>情景选择</span><input type="text"id="sceneType"></div>
        </div>
        <div class="row"><div class="col-xs-4"></div><div class="col-xs-4"></div><div class="col-xs-4"><botton type="button" class="btn system-btn"id="revS">保存</botton></div></div>
        </form>
        </div>
        </div>
        </div>

                `
    )
}

</script>
</html>